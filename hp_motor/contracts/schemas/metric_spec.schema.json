{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://hp-engine.local/schemas/metric_spec.schema.json",
  "title": "HP Engine Metric Spec",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "metric_id",
    "version",
    "full_name",
    "outputs",
    "data_requirements",
    "impl",
    "scopes"
  ],
  "properties": {
    "metric_id": {
      "type": "string",
      "pattern": "^[a-z0-9_]+$"
    },
    "version": {
      "type": "string",
      "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$"
    },
    "full_name": {
      "type": "string"
    },
    "short_name": {
      "type": "string"
    },
    "aliases": {
      "type": "array",
      "items": {
        "type": "string"
      }
    },
    "category": {
      "type": "string"
    },
    "subcategory": {
      "type": "string"
    },
    "complexity": {
      "type": "string",
      "enum": [
        "low",
        "medium",
        "high",
        "research"
      ]
    },
    "polarity": {
      "type": "string",
      "enum": [
        "higher_is_better",
        "lower_is_better",
        "contextual",
        "two_sided"
      ]
    },
    "unit": {
      "type": "string"
    },
    "outputs": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": [
          "name",
          "type"
        ],
        "properties": {
          "name": {
            "type": "string"
          },
          "type": {
            "type": "string",
            "enum": [
              "float",
              "int",
              "string",
              "bool",
              "array",
              "object"
            ]
          },
          "range": {
            "type": "array",
            "items": {
              "type": "number"
            },
            "minItems": 2,
            "maxItems": 2
          }
        }
      }
    },
    "scopes": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "string"
      }
    },
    "data_requirements": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "required_fields"
      ],
      "properties": {
        "required_fields": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "string"
          }
        },
        "optional_fields": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "minimum_sample_size": {
          "type": "integer",
          "minimum": 0
        }
      }
    },
    "derivation": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "level": {
          "type": "integer",
          "minimum": 0,
          "maximum": 5
        },
        "requires_signals": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "requires_metrics": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "fallbacks": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": [
              "name",
              "requires_fields",
              "notes"
            ],
            "properties": {
              "name": {
                "type": "string"
              },
              "requires_fields": {
                "type": "array",
                "items": {
                  "type": "string"
                }
              },
              "notes": {
                "type": "string"
              },
              "expected_degradation": {
                "type": "string"
              }
            }
          }
        }
      }
    },
    "enables": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "direct_derivatives": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "composites": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "dimensions": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": [
          "dimension",
          "inference_type",
          "evidence_strength"
        ],
        "properties": {
          "dimension": {
            "type": "string"
          },
          "inference_type": {
            "type": "string",
            "enum": [
              "direct",
              "proxy",
              "composite"
            ]
          },
          "evidence_strength": {
            "type": "number",
            "minimum": 0.0,
            "maximum": 1.0
          },
          "requires": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "notes": {
            "type": "string"
          }
        }
      }
    },
    "impl": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "module",
        "function"
      ],
      "properties": {
        "module": {
          "type": "string"
        },
        "function": {
          "type": "string"
        },
        "runtime": {
          "type": "string",
          "enum": [
            "python",
            "sql",
            "external"
          ]
        }
      }
    },
    "validation": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "tests": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": [
              "name",
              "type",
              "target"
            ],
            "properties": {
              "name": {
                "type": "string"
              },
              "type": {
                "type": "string",
                "enum": [
                  "calibration",
                  "discrimination",
                  "sanity",
                  "benchmark"
                ]
              },
              "target": {
                "type": "string"
              },
              "notes": {
                "type": "string"
              }
            }
          }
        }
      }
    },
    "citations": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": [
          "ref_id",
          "relation"
        ],
        "properties": {
          "ref_id": {
            "type": "string"
          },
          "relation": {
            "type": "string",
            "enum": [
              "definition",
              "method",
              "benchmark",
              "limitation"
            ]
          },
          "locator": {
            "type": "string"
          }
        }
      }
    }
  }
}